'use strict';

var stars = document.querySelectorAll('#rate span'),
    starsQuantity = stars.length,
    form = $('#comment-form'),
    landpage = document.getElementById('landpage'),
    aboutUsButton = document.getElementById('aboutUsButton'),
    commentFormWrap = $('#comment-form-wrapper'),
    months = ['stycznia', 'lutego', 'marca', 'kwietnia', 'maja', 'czerwca', 'lipca', 'sierpnia', 'września', 'października', 'listopada', 'grudnia'];

var clickedStar = 0;

function init() {
  setNavigationForAboutUsButton();

  hideLandingPage();

  rateComment();
  dateFormat(document);
  showHideDropdownMenu();

  addOpinionButtonAction();
  addFunctionPostComment();
  addFunctionDestroyComment();
  addFunctionEditComment();
}

init();

function setNavigationForAboutUsButton() {
  aboutUsButton.addEventListener('click', function () {
    this.classList.add('collapse__buttons--active');
  });
}

function hideLandingPage() {
  landpage.addEventListener("transitionend", function () {
    this.remove();
  });
  $('#button-getStarted').one('click', function () {
    $(this).removeClass('pulse');
    landpage.classList.add('landpage--hidden');
    aboutUsButton.classList.add('collapse__buttons--active');
  });
}

function rateComment() {
  function piceofCode(i) {
    stars[i].innerHTML = '&#9733;';
    stars[i].classList.add('new-comment-form__rate--hover');
  }
  for (var i = 0; i < starsQuantity; i++) {
    stars[i].addEventListener('click', function () {
      clickedStar = this.getAttribute('value');
      document.querySelector('#rateNum').setAttribute('value', clickedStar);
      resetStars();
      for (var _i = 0; _i < clickedStar; _i++) {
        piceofCode(_i);
      }
    });
    stars[i].addEventListener('mouseenter', function () {
      resetStars();
      for (var _i2 = 0; _i2 < this.getAttribute('value'); _i2++) {
        piceofCode(_i2);
      }
    });
    stars[i].addEventListener('mouseleave', function () {
      resetStars();
      for (var _i3 = 0; _i3 < clickedStar; _i3++) {
        piceofCode(_i3);
      }
    });
  }
}

function dateFormat(objective) {
  var dateFields = objective.querySelectorAll('.content__date'),
      timestampNow = Date.now(),
      divider = 1000 * 60 * 60 * 24;
  for (var i = 0, len = dateFields.length; i < len; i++) {
    var commentDate = new Date(dateFields[i].innerText),
        commentMinutes = commentDate.getMinutes(),
        commentTime = commentDate.getHours() + ':' + (commentMinutes < 10 ? '0' : '') + commentMinutes,
        commentTimestamp = commentDate.getTime(),
        dateComparison = Math.floor((timestampNow - commentTimestamp) / divider);
    if (dateComparison <= 1) {
      dateFields[i].innerText = 'Dzi\u015B o ' + commentTime;
    } else if (dateComparison <= 2) {
      dateFields[i].innerText = 'Wczoraj o ' + commentTime;
    } else if (dateComparison <= 30) {
      dateFields[i].innerText = dateComparison + ' dni temu';
    } else {
      dateFields[i].innerText = commentDate.getDate() + ' ' + months[commentDate.getMonth()];
    }
    $(dateFields[i]).show(0);
  }
}

function showHideDropdownMenu(objective) {
  // show dropdown
  var commentDropdown = !objective ? $(document.querySelectorAll('.content__dropdown-wrapper')) : $(objective),
      allDropdownMenus = commentDropdown.find('.dropdown-wrapper__menu');
  commentDropdown.each(function () {
    var _this = this;

    $(this).off().on('click', function () {
      var thisMenu = $(_this).find('.dropdown-wrapper__menu');
      allDropdownMenus.not(thisMenu).removeClass('visibility--visible');
      thisMenu.toggleClass('visibility--visible');
    });
  });
  // hide dropdown
  $(document).on('click', function (event) {
    if (!$(event.target).closest('.content__dropdown-wrapper').length) {
      allDropdownMenus.removeClass('visibility--visible');
    }
  });
}

function addOpinionButtonAction() {
  var button = document.getElementById('button-addOpinion');
  button.addEventListener('click', function () {
    this.classList.add('visibility--hidden');
    document.getElementById('comment-form-wrapper').classList.add('container__new-comment-form-wrapper--visible');
    scrollToObjective(commentFormWrap);
  });
}

function addFunctionPostComment() {
  $('#button-sendOpinion').click(function () {
    var data = {
      'numOfStars': form.find('#rateNum').val(),
      'commentText': form.find('#text').val(),
      'commentAvatar': form.find('#avatar').val(),
      'commentAuthor': form.find('#currentuser').val()
    };
    // console.log(data);
    if (data.numOfStars && data.commentText) {
      postCommentToDatabase(data);
    }
  });
}

function postCommentToDatabase(data) {
  $.ajax({
    type: 'POST',
    // url: 'http://localhost:3000/',
    url: 'https://evening-hamlet-47726.herokuapp.com/',
    data: data,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    success: function success(commentId) {
      data.commentId = commentId;
      form[0].reset();
      resetStars();
      clickedStar = 0;
      displayPostedComment(data);
      scrollToObjective(commentFormWrap);
      addFunctionDestroyComment();
      addFunctionEditComment();
    },
    error: error
  });
}

function displayPostedComment(data) {
  // console.log('dataL!!!!!', data);
  var commentRating = '',
      template = $('#commentHiddenTemplate').children().clone()[0];
  for (var i = 0; i < data.numOfStars; i++) {
    commentRating += '&#9733;';
  }
  template.getElementsByTagName('img')[0].setAttribute('src', data.commentAvatar);
  template.getElementsByClassName('content__author')[0].innerText = data.commentAuthor;
  template.getElementsByClassName('content__rate')[0].innerHTML = commentRating;
  template.getElementsByClassName('content__text')[0].innerText = data.commentText;
  template.getElementsByClassName('content__date')[0].innerText = Date();
  $(template.getElementsByClassName('button-DeleteComment')[0]).parent().attr('data', data.commentId);
  dateFormat(template);
  $(template.outerHTML).appendTo('#comments-wrapper');
  showHideDropdownMenu(document.querySelectorAll('.content__dropdown-wrapper'));
}

function addFunctionDestroyComment() {
  var buttonDeleteComment = $('.button-DeleteComment');
  buttonDeleteComment.each(function () {
    var _this2 = this;

    $(this).on('click', function () {
      var data = {
        'commentId': $.trim($(_this2).parent().attr('data'))
      };
      // console.log('commentId: ', commentId);
      $.ajax({
        // url: 'http://localhost:3000/',
        url: 'https://evening-hamlet-47726.herokuapp.com',
        data: data,
        type: 'DELETE',
        success: function success() {
          $(_this2).closest('.comments-wrapper__comment').remove();
        },
        error: error
      });
    });
  });
}

function addFunctionEditComment() {
  var buttonEditComment = $('.button-EditComment'),
      btnToggleDropdown = $(document.querySelectorAll('.dropdown-wrapper__button'));
  buttonEditComment.each(function () {
    var _this3 = this;

    $(this).on('click', function () {
      var data = {
        'commentId': $.trim($(_this3).parent().attr('data'))
      },
          commentContent = $(_this3).closest('div.comment__content'),
          textDiv = commentContent.find('div.content__text'),
          oldCommentText = textDiv.text().trim(),
          editForm = '<form id=\'edit-form\' class=\'content__edit-form\'>\n                        <textarea id=\'text-area\' class=\'edit-form__textarea\'>' + oldCommentText + '</textarea>\n                        <div class=\'edit-form__buttons-container\'>\n                          <button type=\'button\' id=\'buttonAccept\' class=\'button button--small button--accept\'>Zatwierd\u017A</button>\n                          <button type=\'button\' id=\'buttonCancel\' class=\'button button--small button--cancel\'>Anuluj</button>\n                        </div>\n                      </form>';

      btnToggleDropdown.addClass('display--none');
      textDiv.replaceWith(editForm).promise().done(function () {
        var editForm = commentContent.find('#edit-form');
        //button-accept
        commentContent.find('#buttonAccept').on('click', function () {
          data.editFormText = editForm.find('#text-area').val();
          var newTextDiv = textDiv.text(data.editFormText),
              dataForDisplay = {
            'editForm': editForm,
            'newTextDiv': newTextDiv,
            'btnToggleDropdown': btnToggleDropdown
          };
          if (data.editFormText !== oldCommentText) {
            updateCommentToDatabase(data, dataForDisplay);
          }
        });
        //button-cancel
        commentContent.find('#buttonCancel').on('click', function () {
          editForm.replaceWith(textDiv);
          btnToggleDropdown.removeClass('display--none');
        });
      });
    });
  });
}

function updateCommentToDatabase(data, dataForDisplay) {
  $.ajax({
    type: 'PUT',
    // url: 'http://localhost:3000/',
    url: 'https://evening-hamlet-47726.herokuapp.com',
    data: data,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    success: function success() {
      displayEditedComment(dataForDisplay);
    },
    error: error
  });
}

function displayEditedComment(dataForDisplay) {
  dataForDisplay.editForm.replaceWith(dataForDisplay.newTextDiv);
  dataForDisplay.btnToggleDropdown.removeClass('display--none');
}

function error(jqXHR, textStatus, errorThrown) {
  console.log('Error');
}

function scrollToObjective(objective) {
  var duration = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 800;

  $('body,html').animate({
    scrollTop: objective.offset().top
  }, duration);
}

function resetStars() {
  for (var i = 0; i < starsQuantity; i++) {
    stars[i].innerHTML = '&#9734;';
    stars[i].classList.remove('new-comment-form__rate--hover');
  }
}
